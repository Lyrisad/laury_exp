/**
 * Fonction principale traitant les requêtes GET.
 * Possibles actions :
 *   - getQuestions
 *   - getQuestion
 *   - addQuestion
 *   - editQuestion
 *   - deleteQuestion
 *   - submitResponse
 */
function doGet(e) {
  var action = e.parameter.action;
  var result = {};
  
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    
    if (action == "getQuestions") {
      var sheet = ss.getSheetByName("Questions");
      var data = sheet.getDataRange().getValues();
      // La première ligne contient les en-têtes.
      result.values = data.slice(1).map(function(row) {
        return {
          order: row[0],
          question: row[1],
          type: row[2],
          responses: row[3] ? JSON.parse(row[3]) : []
        };
      });
      
    } else if (action == "getQuestion") {
      var sheet = ss.getSheetByName("Questions");
      var order = parseInt(e.parameter.order);
      if (!order) {
        throw new Error("Ordre de question manquant");
      }
      
      var data = sheet.getDataRange().getValues();
      var found = false;
      for (var i = 1; i < data.length; i++) {
        if (data[i][0] == order) {
          result.question = {
            order: data[i][0],
            question: data[i][1],
            type: data[i][2],
            responses: data[i][3] ? JSON.parse(data[i][3]) : []
          };
          found = true;
          break;
        }
      }
      if (!found) {
        throw new Error("Question non trouvée");
      }
      
    } else if (action == "addQuestion") {
      var sheet = ss.getSheetByName("Questions");
      var order = parseInt(e.parameter.order);
      var question = e.parameter.question;
      var type = e.parameter.type;
      var responses = e.parameter.responses ? JSON.parse(e.parameter.responses) : [];
      
      if (!order || !question || !type) {
        throw new Error("Paramètres manquants");
      }
      
      // Vérifier que l'ordre n'existe pas déjà.
      var data = sheet.getDataRange().getValues();
      for (var i = 1; i < data.length; i++) {
        if (data[i][0] == order) {
          throw new Error("Une question avec cet ordre existe déjà");
        }
      }
      
      sheet.appendRow([order, question, type, JSON.stringify(responses)]);
      result.success = true;
      result.message = "Question ajoutée avec succès";
      
    } else if (action == "editQuestion") {
      var sheet = ss.getSheetByName("Questions");
      var originalOrder = parseInt(e.parameter.originalOrder);
      var order = parseInt(e.parameter.order);
      var question = e.parameter.question;
      var type = e.parameter.type;
      var responses = e.parameter.responses ? JSON.parse(e.parameter.responses) : [];
      
      if (!order || !question || !type) {
        throw new Error("Paramètres manquants");
      }
      
      var data = sheet.getDataRange().getValues();
      var found = false;
      for (var i = 1; i < data.length; i++) {
        if (data[i][0] == originalOrder) {
          // Mise à jour des colonnes ORDER, QUESTION, TYPE et REPONSES
          sheet.getRange(i + 1, 1, 1, 4).setValues([[order, question, type, JSON.stringify(responses)]]);
          found = true;
          break;
        }
      }
      if (!found) {
        throw new Error("Question non trouvée");
      }
      result.success = true;
      result.message = "Question modifiée avec succès";
      
    } else if (action == "deleteQuestion") {
      var sheet = ss.getSheetByName("Questions");
      var order = parseInt(e.parameter.order);
      if (!order) {
        throw new Error("Ordre de question manquant");
      }
      
      var data = sheet.getDataRange().getValues();
      var found = false;
      for (var i = 1; i < data.length; i++) {
        if (data[i][0] == order) {
          sheet.deleteRow(i + 1);
          found = true;
          break;
        }
      }
      if (!found) {
        throw new Error("Question non trouvée");
      }
      result.success = true;
      result.message = "Question supprimée avec succès";
      
    } else if (action == "submitResponse") {
      // Cette action peut être testée en GET (passage de paramètres dans l'URL)
      // ou utilisée via POST (cf. doPost ci‑dessous).
      
      var sheet = ss.getSheetByName("Données");
      // Si la feuille n'existe pas, on la crée et on y écrit les en-têtes.
      if (!sheet) {
        sheet = ss.insertSheet("Données");
        var qSheet = ss.getSheetByName("Questions");
        var qData = qSheet.getDataRange().getValues();
        var headers = ["Date", "Sexe", "Age", "Poste"];
        for (var i = 1; i < qData.length; i++) {
          headers.push(qData[i][1]); // La colonne QUESTION de la feuille "Questions"
        }
        sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      }
      
      var timestamp = e.parameter.timestamp;
      var sexe = e.parameter.sexe;
      var age = e.parameter.age;
      var poste = e.parameter.poste;
      var responses = e.parameter.responses ? JSON.parse(e.parameter.responses) : [];
      var rowData = [timestamp, sexe, age, poste];
      
      // Récupérer les questions afin d'ordonner les réponses.
      var qSheet = ss.getSheetByName("Questions");
      var qData = qSheet.getDataRange().getValues();
      for (var i = 1; i < qData.length; i++) {
        var qText = qData[i][1];
        var resp = "";
        for (var j = 0; j < responses.length; j++) {
          if (responses[j].question == qText) {
            resp = responses[j].answer;
            break;
          }
        }
        rowData.push(resp);
      }
      sheet.appendRow(rowData);
      result.success = true;
      result.message = "Réponses enregistrées avec succès";
      
    } else {
      throw new Error("Action non reconnue");
    }
  } catch (err) {
    result.error = err.toString();
  }
  
  // Si une callback est demandée (JSONP), on l'applique.
  var output = JSON.stringify(result);
  if (e.parameter.callback) {
    output = e.parameter.callback + "(" + output + ")";
    return ContentService.createTextOutput(output).setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
  return ContentService.createTextOutput(output).setMimeType(ContentService.MimeType.JSON);
}


/**
 * Fonction principale traitant les requêtes POST.
 * Elle est surtout utilisée pour la soumission des réponses du questionnaire.
 */
function doPost(e) {
  var result = {};
  
  try {
    var data = JSON.parse(e.postData.contents);
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    
    if (data.sexe && data.age && data.poste && data.responses) {
      var sheet = ss.getSheetByName("Données");
      // Création de la feuille "Données" si elle n'existe pas.
      if (!sheet) {
        sheet = ss.insertSheet("Données");
        var qSheet = ss.getSheetByName("Questions");
        var qData = qSheet.getDataRange().getValues();
        var headers = ["Date", "Sexe", "Age", "Poste"];
        for (var i = 1; i < qData.length; i++) {
          headers.push(qData[i][1]);
        }
        sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      }
      
      var rowData = [data.timestamp, data.sexe, data.age, data.poste];
      var qSheet = ss.getSheetByName("Questions");
      var qData = qSheet.getDataRange().getValues();
      for (var i = 1; i < qData.length; i++) {
        var qText = qData[i][1];
        var resp = "";
        for (var j = 0; j < data.responses.length; j++) {
          if (data.responses[j].question == qText) {
            resp = data.responses[j].answer;
            break;
          }
        }
        rowData.push(resp);
      }
      sheet.appendRow(rowData);
      result.success = true;
      result.message = "Réponses enregistrées avec succès";
    } else {
      throw new Error("Paramètres manquants dans le POST");
    }
  } catch (err) {
    result.error = err.toString();
  }
  
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}
